<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مستكشف افتتاحيات الشطرنج (ECO)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; text-align: center; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; }
        .search-box { margin-bottom: 20px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; }
        input:focus { border-color: #3498db; }
        button { padding: 12px 25px; background: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: 0.3s; }
        button:hover { background: #219150; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        #status { margin-bottom: 15px; color: #7f8c8d; font-size: 14px; }
        .result-card { border-top: 2px solid #eee; margin-top: 20px; padding-top: 20px; text-align: right; display: none; }
        .eco-code { display: inline-block; background: #e67e22; color: white; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 10px; }
        .opening-name { font-size: 24px; color: #2c3e50; margin: 5px 0; }
        .moves { background: #ecf0f1; padding: 10px; border-radius: 6px; font-family: monospace; color: #2980b9; }
        .error { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>مستكشف افتتاحيات الشطرنج ♟️</h1>
    <div id="status">جاري تحميل بيانات الافتتاحيات (12,000+)...</div>

    <div class="search-box">
        <input type="text" id="fenInput" placeholder="أدخل كود FEN (مثلاً: rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1)">
        <button id="searchBtn" disabled>بحث</button>
    </div>

    <div id="error" class="error"></div>

    <div id="result" class="result-card">
        <div class="eco-code" id="resEco"></div>
        <div class="opening-name" id="resName"></div>
        <p><strong>النقلات:</strong></p>
        <div class="moves" id="resMoves"></div>
    </div>
</div>

<script>
    const baseUrl = "https://raw.githubusercontent.com/chess-openings/eco.json/main/data/";
    const files = ["ecoA.json", "ecoB.json", "ecoC.json", "ecoD.json", "ecoE.json", "eco_interpolated.json"];
    let openingDb = {};

    // 1. جلب البيانات من GitHub ودمجها
    async function initDatabase() {
        try {
            const fetchPromises = files.map(file => fetch(baseUrl + file).then(res => res.json()));
            const allData = await Promise.all(fetchPromises);
            
            // دمج كل الملفات في كائن واحد (المفاتيح هي الـ FEN)
            allData.forEach(data => {
                openingDb = { ...openingDb, ...data };
            });

            document.getElementById('status').innerText = "✅ تم تحميل 12,000+ افتتاحية. جاهز للبحث!";
            document.getElementById('searchBtn').disabled = false;
        } catch (err) {
            document.getElementById('status').innerHTML = "<span class='error'>فشل تحميل البيانات. تأكد من اتصالك بالإنترنت.</span>";
            console.error(err);
        }
    }

    // 2. معالجة FEN للبحث (تنظيف العدادات غير الضرورية)
    function normalizeFen(fen) {
        // FEN يتكون من 6 أجزاء، الافتتاحيات غالباً لا تهتم بآخر جزئين (عداد النقلات)
        const parts = fen.trim().split(/\s+/);
        if (parts.length < 4) return fen.trim();
        return parts.slice(0, 4).join(" "); // نأخذ القطع، الدور، التبييت، ومربع التجاوز
    }

    // 3. وظيفة البحث
    function searchOpening() {
        const inputFen = document.getElementById('fenInput').value.trim();
        const errorDiv = document.getElementById('error');
        const resultDiv = document.getElementById('result');
        
        errorDiv.innerText = "";
        resultDiv.style.display = "none";

        if (!inputFen) return;

        // البحث المباشر
        let match = openingDb[inputFen];

        // إذا لم يجد، نحاول البحث بالـ FEN المختصر (بدون عدادات النقلات)
        if (!match) {
            const shortFen = normalizeFen(inputFen);
            // نبحث في قاعدة البيانات عن أي مفتاح يبدأ بهذا الـ FEN المختصر
            const foundKey = Object.keys(openingDb).find(k => k.startsWith(shortFen));
            if (foundKey) match = openingDb[foundKey];
        }

        if (match) {
            document.getElementById('resEco').innerText = match.eco;
            document.getElementById('resName').innerText = match.name;
            document.getElementById('resMoves').innerText = match.moves || "غير متوفرة";
            resultDiv.style.display = "block";
        } else {
            errorDiv.innerText = "لم يتم العثور على افتتاحية مطابقة لهذه الوضعية.";
        }
    }

    // تشغيل التحميل عند فتح الصفحة
    initDatabase();

    // ربط الأزرار
    document.getElementById('searchBtn').addEventListener('click', searchOpening);
    document.getElementById('fenInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchOpening();
    });
</script>

</body>
</html>
